<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('All Perks')"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container full-width">
    <h1>Perks</h1>

    <div class="actions">
        <a th:href="@{/perks/add}" class="btn-primary">Add a Perk</a>
    </div>

    <form method="get" th:action="@{/perks}" class="filter-form">
        <div class="filter-pair">
            <label>Membership Type:</label>
            <select name="membershipType">
                <option value="">All</option>
                <option th:each="type : ${membershipTypes}"
                        th:value="${type}"
                        th:text="${type}"
                        th:selected="${type.equals(membershipType)}">
                </option>
            </select>
        </div>

        <div class="filter-pair">
            <label>Region:</label>
            <input type="text" name="region" th:value="${region}"/>
        </div>

        <div class="filter-pair">
            <label>Expiry Only:</label>
            <input type="checkbox" name="expiryOnly" th:checked="${expiryOnly}"/>
        </div>

        <input type="hidden" name="sort" th:value="${sort}"/>
        <input type="hidden" name="direction" th:value="${direction}"/>
        <input type="hidden" name="page" value="0"/>
        <input type="hidden" name="size" th:value="${size}"/>
        <div class="actions">
            <button type="submit">Filter</button>
        </div>
    </form>


    <table>
        <thead>
        <tr>
            <th>Save</th>
            <th>Benefit</th>
            <th>Membership Type</th>
            <th>Membership</th>
            <th>Membership Organization</th>
            <th>Product</th>
            <th>Product Company</th>
            <th>Product Description</th>
            <th>Region</th>
            <th class="sortable">
                Expiry<br>
                <a th:href="@{/perks(sort='expiry', direction='asc', page=${page}, size=${size}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}" class="btn-small">↑</a>
                <a th:href="@{/perks(sort='expiry', direction='desc', page=${page}, size=${size}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}" class="btn-small">↓</a>
            </th>
            <th class="sortable">
                Rating<br>
                <a th:href="@{/perks(sort='rating', direction='asc', page=${page}, size=${size}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}" class="btn-small">↑</a>
                <a th:href="@{/perks(sort='rating', direction='desc', page=${page}, size=${size}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}" class="btn-small">↓</a>
            </th>
            <th>Vote</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="perk : ${perks}">
            <td>
                <div class="perk-save-forms"
                     th:attr="data-perk-id=${perk.id},
                              data-logged-in=${isAuthenticated},
                              data-csrf-header=${_csrf.headerName},
                              data-csrf-token=${_csrf.token},
                              data-save-state=${saveStates[perk.id]}">
                    <form class="flat-form" th:action="@{/perks/{id}/save(id=${perk.id})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="page" th:value="${page}"/>
                        <button class = "btn-small save-perk"  th:classappend="${saveStates[perk.id] == 1} ? ' saved' : ''"type="submit">
                            ★
                        </button>
                    </form>
                </div>
            </td>
            <td th:text="${perk.benefit}"></td>
            <td th:text="${perk.membership != null ? perk.membership.type : 'None'}"></td>
            <td th:text="${perk.membership != null ? perk.membership.description : 'None'}"></td>
            <td th:text="${perk.membership != null ? perk.membership.organizationName : 'None'}"></td>
            <td th:text="${perk.product != null ? perk.product.name : 'None'}"></td>
            <td th:text="${perk.product != null ? perk.product.company : 'None'}"></td>
            <td th:text="${perk.product != null ? perk.product.description : ''}"></td>
            <td th:text="${perk.region != null ? perk.region : 'Global'}"></td>
            <td th:text="${perk.expiryDate != null ? #dates.format(perk.expiryDate.time, 'yyyy-MM-dd') : 'No Expiry'}"></td>
            <td th:text="${perk.rating}"></td>
            <td>
                <div class="vote-forms"
                     th:attr="data-perk-id=${perk.id},
                              data-logged-in=${isAuthenticated},
                              data-csrf-header=${_csrf.headerName},
                              data-csrf-token=${_csrf.token},
                              data-vote-state=${voteStates[perk.id]}">
                    <form class="flat-form" th:action="@{/perks/{id}/upvote(id=${perk.id})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="page" th:value="${page}"/>
                        <button class="btn-small upvote" type="submit"
                                th:classappend="${voteStates[perk.id] == 1} ? ' voted' : ''">▲</button>
                    </form>
                    <form class="flat-form" th:action="@{/perks/{id}/downvote(id=${perk.id})}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="page" th:value="${page}"/>
                        <button class="btn-small downvote" type="submit"
                                th:classappend="${voteStates[perk.id] == -1} ? ' voted' : ''">▼</button>
                    </form>

                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="pager" th:if="${totalPages > 1}">
        <span th:text="'Total: ' + ${totalPerks} + ' perks'"></span>
        <br/>
        <a th:if="${page > 0}" th:href="@{/perks(page=${page - 1}, size=${size}, sort=${sort}, direction=${direction}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}">Prev</a>
        <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
            <a th:if="${i != page}" th:text="${i + 1}" th:href="@{/perks(page=${i}, size=${size}, sort=${sort}, direction=${direction}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}"></a>
            <span th:if="${i == page}" th:text="${i + 1}" class="current"></span>
        </span>
        <a th:if="${page < totalPages - 1}" th:href="@{/perks(page=${page + 1}, size=${size}, sort=${sort}, direction=${direction}, membershipType=${membershipType}, region=${region}, expiryOnly=${expiryOnly})}">Next</a>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>

<script th:src="@{/js/votes.js}" type = "module"></script>
<script th:src="@{/js/save-perks-search.js}" type = "module"></script>
<script th:src="@{/js/perks-table.js}" type = "module"></script>
<script th:inline="javascript" type = "module">
    window.ALL_PERKS = /*[[${perksJson}]]*/ [];
</script>
</body>
</html>


